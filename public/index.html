<!DOCTYPE html>
<html>
<head>
    <title>Key Sender</title>
    <style>
        #touchpad {
            width: 300px;
            height: 200px;
            border: 2px solid black;
            margin-top: 10px;
            touch-action: none;
        }
    </style>
</head>
<body>

<h2>Press any key in the input box:</h2>
<input type="text" id="inputBox" autofocus />

<br><br>

<label>
    <input type="checkbox" id="randomMouseCheckbox" />
    Random Mouse Movements
</label>

<br><br>

<label>
    Sensitivity:
    <input type="number" id="sensitivity" value="1" step="0.1" min="0.1" />
</label>

<h2>Touchpad Area:</h2>
<div id="touchpad"></div>

<script>
    const protocol = location.protocol === "https:" ? "wss://" : "ws://";
    const ws = new WebSocket(protocol + location.host);

    ws.onopen = () => console.log("âœ… Connected to server");
    ws.onmessage = (msg) => console.log("ðŸ“¥ Received:", msg.data);

    const input = document.getElementById("inputBox");
    const checkbox = document.getElementById("randomMouseCheckbox");
    const pad = document.getElementById("touchpad");
    const sensitivityInput = document.getElementById("sensitivity");

    input.addEventListener("keyup", (e) => {
        e.preventDefault();

        if (ws.readyState === WebSocket.OPEN) {
            let keys = [];
            console.log(e.key);
            if (e.ctrlKey) keys.push("CONTROL");
            if (e.altKey) keys.push("ALT");
            if (e.shiftKey) keys.push("SHIFT");
            if (e.metaKey) keys.push("META");

            const key = e.key;
            if (!["CONTROL", "ALT", "SHIFT", "META"].includes(key)) {
                keys.push(key);
            }

            if (keys.length > 0) {
                ws.send(JSON.stringify({ keys }));
            }
        }
    });

    checkbox.addEventListener("change", () => {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ random_mouse: checkbox.checked }));
        }
    });

    let lastX = null, lastY = null;
    let mouseDown = false;

    pad.addEventListener("pointerdown", (e) => {
        lastX = e.clientX;
        lastY = e.clientY;
        mouseDown = true;
    });

    pad.addEventListener("pointerup", () => {
        mouseDown = false;
        lastX = null;
        lastY = null;
    });

    pad.addEventListener("pointermove", (e) => {
        if (!mouseDown) return;

        const sensitivity = parseFloat(sensitivityInput.value) || 1;
        const dx = (e.clientX - lastX) * sensitivity;
        const dy = (e.clientY - lastY) * sensitivity;

        lastX = e.clientX;
        lastY = e.clientY;

        // Send as float, or round if ESP-side requires integer
        if (Math.abs(dx) > 0.01 || Math.abs(dy) > 0.01) {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ mouse: { dx: 55, dy: 66 } }));
            }
        }
    });
</script>

</body>
</html>
